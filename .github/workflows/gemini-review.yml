name: Gemini Code Review

on:
  pull_request:
    types: [ opened, synchronize, reopened ]

jobs:
  review:
    runs-on: ubuntu-latest
    if: ${{ secrets.GEMINI_API_KEY != '' }}
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD > /tmp/diff.txt

      - name: Review with Gemini
        uses: actions/github-script@v7
        continue-on-error: true
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const apiKey = process.env.GEMINI_API_KEY;
            if (!apiKey) {
              console.log('GEMINI_API_KEY not configured, skipping review');
              return;
            }

            const fs = require('fs');
            const diff = fs.readFileSync('/tmp/diff.txt', 'utf8').slice(0, 30000);

            const response = await fetch(
              `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`,
              {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  contents: [{
                    parts: [{
                      text: `Review this PR diff. Focus on:
            - Security vulnerabilities
            - Performance issues
            - Code duplication
            - Magic strings/numbers (should use constants)
            - Code style issues

            Be concise. Only mention real problems.

            Diff:
            ${diff}`
                    }]
                  }]
                })
              }
            );

            const data = await response.json();
            console.log('Gemini response:', JSON.stringify(data, null, 2));

            if (data.error) {
              console.log(`Gemini API error: ${data.error.message}`);
              return;
            }

            const review = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!review) {
              console.log('No review generated');
              return;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ðŸ¤– Gemini Code Review\n\n${review}`
            });
